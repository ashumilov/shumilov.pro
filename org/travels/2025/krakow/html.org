#+BEGIN_EXPORT html
<script>
/**
 * Загружает GPX файл, фильтрует точки по дате и отображает маршрут
 * @param {string} gpxFileUrl - URL к GPX файлу
 * @param {string} targetMapId - ID элемента для размещения карты
 * @param {string} mapType - Тип карты: 'osm' или 'google'
 * @param {Date|string} startDate - Начальная дата для фильтрации (null для отключения)
 * @param {Date|string} endDate - Конечная дата для фильтрации (null для отключения)
 * @param {Object} options - Дополнительные параметры (цвет и толщина линии)
 */
function loadGPXFile(gpxFileUrl, targetMapId, mapType = 'osm', startDate = null, endDate = null, options = {}) {
//  console.log(`Загрузка GPX: ${gpxFileUrl}`, {
//    targetMapId, 
//    mapType, 
//    startDate, 
//    endDate, 
//    options
//  });

  // Преобразуем даты в объекты Date, если они переданы как строки
  if (startDate && typeof startDate === 'string') {
    startDate = new Date(startDate);
//    console.log(`Начальная дата преобразована: ${startDate}`);
  }
  if (endDate && typeof endDate === 'string') {
    endDate = new Date(endDate);
//    console.log(`Конечная дата преобразована: ${endDate}`);
  }
  
  // Задаем параметры по умолчанию
  const lineOptions = {
    color: options.color || 'red',
    weight: options.weight || 3,
    opacity: options.opacity || 0.7
  };
  
  // Проверяем существование и размеры контейнера карты перед загрузкой
  const mapContainer = document.getElementById(targetMapId);
  if (!mapContainer) {
    console.error(`Контейнер карты #${targetMapId} не найден!`);
    return;
  }
  
  // Убедимся, что контейнер имеет высоту
  if (mapContainer.offsetHeight === 0) {
//    console.log('Контейнер карты имеет нулевую высоту, устанавливаем минимальную высоту');
    mapContainer.style.height = '500px';
  }
  
//  console.log(`Начинаем запрос к файлу: ${gpxFileUrl}`);
  fetch(gpxFileUrl)
    .then(response => {
//      console.log(`Ответ от сервера: ${response.status} ${response.statusText}`);
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.text();
    })
    .then(gpxText => {
//      console.log(`GPX файл загружен, размер: ${gpxText.length} байт`);
      
      // Парсинг GPX
      const parser = new DOMParser();
      const gpx = parser.parseFromString(gpxText, 'text/xml');
      
      // Проверяем, правильно ли распарсился XML
      const parseError = gpx.querySelector('parsererror');
      if (parseError) {
        console.error('Ошибка парсинга XML:', parseError.textContent);
        throw new Error('Неверный формат GPX файла');
      }
      
      // Извлечение всех точек трека с учетом даты
      const trackPoints = [];
      const tracks = gpx.getElementsByTagName('trk');
//      console.log(`Найдено треков: ${tracks.length}`);
      
      for (let i = 0; i < tracks.length; i++) {
        const segments = tracks[i].getElementsByTagName('trkseg');
//        console.log(`Трек ${i+1}: найдено сегментов: ${segments.length}`);
        
        for (let j = 0; j < segments.length; j++) {
          const points = segments[j].getElementsByTagName('trkpt');
//          console.log(`Трек ${i+1}, сегмент ${j+1}: найдено точек: ${points.length}`);
          
          for (let k = 0; k < points.length; k++) {
            const point = points[k];
            const lat = parseFloat(point.getAttribute('lat'));
            const lon = parseFloat(point.getAttribute('lon'));
            
            // Проверяем временную метку, если указаны даты для фильтрации
            if (startDate || endDate) {
              const timeElement = point.getElementsByTagName('time')[0];
              if (!timeElement) {
//                if (k === 0) console.log('Точка без временной метки, пропускаем');
                continue; // Пропускаем точку, если нет временной метки
              }
              
              const pointTime = new Date(timeElement.textContent);
              
              // Фильтруем по дате
              if (startDate && pointTime < startDate) continue;
              if (endDate && pointTime > endDate) continue;
            }
            
            trackPoints.push([lat, lon]);
          }
        }
      }
      
//      console.log(`Итого после фильтрации: ${trackPoints.length} точек`);
      
      // Если нет точек после фильтрации
      if (trackPoints.length === 0) {
        console.warn('Нет точек для отображения после фильтрации по датам');
      }
      
      // Создаем карту с явными настройками размера
      const mapOptions = {
        zoomControl: true,
        attributionControl: true,
        scrollWheelZoom: true
      };
      
      // Инициализация карты
      const map = L.map(targetMapId, mapOptions);
//      console.log(`Карта создана в элементе #${targetMapId}`);
        
      // Добавление тайлов в зависимости от выбранного типа карты
      if (mapType === 'google') {
//        console.log('Используем Google Maps тайлы');
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
          subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
          attribution: '&copy; Google Maps'
        }).addTo(map);
      } else {
//        console.log('Используем OpenStreetMap тайлы');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
      }
      
      // Если есть точки, создаем маршрут
      if (trackPoints.length > 0) {
        const polyline = L.polyline(trackPoints, lineOptions).addTo(map);
//        console.log('Маршрут добавлен на карту');
        
        // Автоматический зум
        map.fitBounds(polyline.getBounds());
//        console.log('Масштаб карты установлен по границам маршрута');
      } else {
        // Если нет точек, установим стандартный вид
        map.setView([55.751244, 37.618423], 10);
//        console.log('Нет точек для маршрута, установлен стандартный вид карты');
      }
      
      // Принудительный пересчет размеров карты для корректного отображения
      setTimeout(function() {
        map.invalidateSize({ animate: true });
//        console.log('Размеры карты пересчитаны (после инициализации)');
        
        // Повторный зум для гарантии правильного отображения
        if (trackPoints.length > 0) {
          const polyline = L.polyline(trackPoints);
          map.fitBounds(polyline.getBounds());
        }
      }, 300);
      
      // Еще один пересчет через более длительное время для гарантии
      setTimeout(function() {
        map.invalidateSize();
//        console.log('Размеры карты пересчитаны повторно');
      }, 1000);
      
      // Обработчик изменения размера окна
      window.addEventListener('resize', function() {
        map.invalidateSize();
//        console.log('Размеры карты пересчитаны (изменение размера окна)');
      });
      
      // Рассчитываем расстояние
      let distance = 0;
      for (let i = 1; i < trackPoints.length; i++) {
        const p1 = L.latLng(trackPoints[i-1][0], trackPoints[i-1][1]);
        const p2 = L.latLng(trackPoints[i][0], trackPoints[i][1]);
        distance += p1.distanceTo(p2);
      }
//      console.log(`Расчет расстояния: ${(distance / 1000).toFixed(2)} км`);
      
      // Если нужно показать информацию о маршруте
      const infoElement = document.getElementById(targetMapId + '-info');
      if (infoElement) {
        infoElement.innerHTML = `
          <p>Маршрут: ${trackPoints.length} точек</p>
          <p>Расстояние: ${(distance / 1000).toFixed(2)} км</p>
        `;
//        console.log('Информация о маршруте обновлена');
      } else {
//        console.log(`Элемент #${targetMapId}-info не найден, информация не отображена`);
      }
      
      return {
        map: map,
        points: trackPoints,
        distance: distance
      };
    })
    .catch(error => {
      console.error('Ошибка при загрузке GPX файла:', error);
      console.error('URL файла:', gpxFileUrl);
      console.error('Полная информация об ошибке:', {
        message: error.message,
        stack: error.stack,
        name: error.name
      });
      
      const mapElement = document.getElementById(targetMapId);
      if (mapElement) {
        mapElement.innerHTML = `
          <div style="padding: 20px; color: red; background-color: #ffeeee; border: 1px solid #ffaaaa;">
            <h3>Ошибка загрузки GPX файла</h3>
            <p>${error.message}</p>
            <p>Проверьте консоль разработчика для получения дополнительной информации.</p>
          </div>
        `;
      }
    });
}
</script>
#+END_EXPORT
